# 
#    Copyright (C) 2018 Modelon AB
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the Common Public License as published by
#    IBM, version 1.0 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY. See the Common Public License for more details.
#
#    You should have received a copy of the Common Public License
#    along with this program.  If not, see
#     <http://www.ibm.com/developerworks/library/os-cpl.html/>.

ARG DOCKER_LINUX_DIST=centos
ARG DOCKER_DIST_TAG=7.4.1708

FROM $DOCKER_LINUX_DIST:$DOCKER_DIST_TAG
MAINTAINER Modelon

ARG DOCKER_USR_PATH=/tmp/dockerfiles
ARG ENABLE_PYTHON="yes"
ENV PYTHON_ENABLED=${ENABLE_PYTHON}
ENV USR_PATH=${DOCKER_USR_PATH}
ENV DOCKER_SRC_DIR=${USR_PATH}/Docker/build
ARG SRC_DIR=scripts

ARG GCC_INSTALL_TYPE=CENTOS_DEFAULT
ENV GCC_INSTALLATION_TYPE=${GCC_INSTALL_TYPE}
ARG GCC_VERSION_TO_BUILD=6.3.0
ENV GCC_VERSION=${GCC_VERSION_TO_BUILD}

ARG PYTHON_VERSION=3
ENV PYTHON_VERSION=${PYTHON_VERSION}

RUN useradd -ms /bin/bash baseuser && groupadd docker && usermod -aG docker baseuser
# switch user back and forth to create bashrc
USER baseuser
USER root

COPY ${SRC_DIR}/*.sh ${DOCKER_SRC_DIR}/
COPY ${SRC_DIR}/jcc.patch ${DOCKER_SRC_DIR}/
COPY ${SRC_DIR}/jcc35.patch ${DOCKER_SRC_DIR}/
RUN chmod +x ${DOCKER_SRC_DIR}/*.sh

# split the scripts into separate RUNS in order to utilize caching in case build fails mid build
RUN ${DOCKER_SRC_DIR}/setup_openjdk.sh
RUN ${DOCKER_SRC_DIR}/setup_requirements.sh
RUN ${DOCKER_SRC_DIR}/setup_gcc.sh
RUN ${DOCKER_SRC_DIR}/setup_python.sh
RUN ${DOCKER_SRC_DIR}/setup_ant.sh
RUN ${DOCKER_SRC_DIR}/setup_jcc.sh
RUN ${DOCKER_SRC_DIR}/centos_python_env.sh
RUN ${DOCKER_SRC_DIR}/setup_ipopt.sh
RUN rm -rf ${USR_PATH}
RUN rm -rf /*.tgz
RUN ln -s /opt/ant/bin/ant /usr/bin/ant
USER baseuser