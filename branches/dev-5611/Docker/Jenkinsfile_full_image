node('docker') {
    def jm_image
    stage("Checkout JModelica.org") {
        checkout([
            $class: 'SubversionSCM',
            locations: [
            [local: 'JModelica', remote: scm.getLocations()[0].remote],
        ],
            workspaceUpdater: [$class: 'UpdateWithCleanUpdater'],
            quietOperation: true,
        ])
    }
    stage ('Build') {
        dir ("JModelica") {
            def dockerfile = 'Dockerfile_full_image'
            jm_image = docker.build("jmodelica-image", "-f ${dockerfile} . --no-cache --build-arg DOCKER_LINUX_DIST=jmodelica/ubuntu_base --build-arg DOCKER_DIST_TAG=latest --build-arg JM_TESTS_WS=${WORKSPACE}")
            jm_image.inside{
                sh 'pwd && echo "Finished building"'
            }
        }
    }
    stage ('Testing') {
        dir ("JModelica") {
            
            jm_image.inside {
                try {
                    sh 'pwd && ls -la && cd /home/jenkins/jm_install && mkdir -p ${WORKSPACE}/test_results && ls -la && ./jm_tests -ie -x "${WORKSPACE}/test_results" && ls -la && pwd'
                } finally {
                    junit testResults: 'test_results/*.xml', allowEmptyResults: true
                    sh 'echo ${WORKSPACE}'
                }
            }
        }
    }
}